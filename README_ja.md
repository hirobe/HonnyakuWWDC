# HonnyakuWWDC

HonnyakuWWDCは、WWDCの動画をDeepLで日本語に翻訳し、さらにiOS/Macの音声アシスタントで動画に同期して読み上げるアプリです。
喋るタイミングと動画の再生を同期しているので、動画の画像と大きくずれることなく日本語で聞くことができます。

このアプリはiOS16betaの機能(主に正規表現)を使い、UIもできる限りSwift UIを用いて作成しています。ソースコードがSwift学習の参考になれば幸いです。

https://user-images.githubusercontent.com/85206/177453843-14c8dd98-288d-4f02-948a-5e99cd89120c.mov

注意：このアプリを使うにはDeepLのAPI Keyが必要です。つまり、DeepLにアカウントを作成しておく必要があります。また、翻訳の際にはDeepLのあなたのアカウントの`翻訳可能な残りの文字数`を消費する点に注意してください。長さによりますが、大体1セッションの動画あたり20,000字前後になるかと思います。（このアプリ・ソースコードには翻訳後の文章は含まれません。アプリは、実行時にDeepLのAPIを呼び出してWWDC Webサイトからスクレイピングした文章を翻訳します。）

## アプリの構成

このアプリは、iOS16betaで動作する本体(HonnyakuWWDC)と、iOS15/MacOS12.4で動作するPlayer(HonnyakuWWDCClassicPlayer)の二つのアプリで構成されています。元々は、本体のみで全て動くように開発していたのですが、iOS16Beta1/2のシミュレータで読み上げ音声が選択できなかったため旧OSで動くPlayerを作成しました。

- HonnyakuWWDC

  本体。動画の選択と翻訳、再生ができます。iOS16Beta用です。
  iPadで動かすことを想定していますが、MacやiPhoneでも多分動きます。
  
  スクリーンショットは、iOS Beta版の機能を使っているため割愛します。

- HonnyakuWWDCClassicPlayer

  iOS15/MacOS12.4で動くプレイヤー。本体で作成した翻訳データの再生のみができます。
  <img width="480" alt="capture11" src="https://user-images.githubusercontent.com/85206/177461490-bacdda38-82be-4513-a960-39cfc8cb9d21.png">


## How to use

以下はMac上でXcode14.0 beta2を使って動かすための手順です。

1. アプリを起動する前に、日本語の音声読み上げを使うには音声ファイルのダウンロードが必要です。動かしたい環境（Mac）の`設定`→`アクセシビリティ`→`読み上げコンテンツ`から`システムの声`を選択し、`カスタマイズ...`から使いたい声(Kyokoを推奨)をダウンロードしてください。Siriを選びたいところですが、残念ながらアプリではSiriを使うことはできません。

2. Xcode14.0 beta2でWWDCPlayerをビルドし、iPadのシュミレータを実行します。

3. アプリのサイドのリストを表示し、ギアボタンを押して設定画面を開きます。
DeepLのキーを入力します。DeepLのProアカウントの場合はPro AccountのスイッチをONにします。

4. 設定画面で、WWDC2022 - WWDC2020のうち、見たいカンファレンスをONにします。ONにするとリストのダウンロード（サイトのスクレイピング）が始まります。10秒くらいかかります。

5. 画面左リストに動画の一覧が表示されます。選択すると動画のWebサイトが表示されます。画面上部のTransferボタンを押すと音声データのスクレイピングとDeepLを用いた翻訳を行います。この時点でDeepLの`翻訳可能な残りの文字数`を消費します。翻訳等に1分くらい時間がかかります。

6. 翻訳に成功すると動画が表示されます。このまま動画を見ることもできますが、beta版のシュミレータでは日本語の音声を聞くことができません。ここでPlayerアプリを使います。

   まず、本体アプリ右上の`…`ボタンから`データをCopy`を選択してください。翻訳データがクリップボードにコピーされます。
   
   次に、XcodeからHonnyakuWWDCClassicPlayerをMac用に起動してください。プレイヤーアプリの設定画面を開き、声(Kyoko)を選択した後、データを貼り付けボタンを押してください。うまく貼り付けできていれば、画面の上部に動画のタイトルが表示されます。
   
   あとは、プレビューアプリの再生ボタンを押して動画を再生してください。

## 声と映像を同期させる仕組み

WWDCのVideoのWebサイトには、各文章の開始時間が書かれています。クリックしたらそこから動画を始められるようになっている訳ですね。これを取得して翻訳し、日本語＋各文の開始時間の情報を得ます。DeepLはHTMLやXMLに対応しており、文章中にタグを入れたまま翻訳することができます。

あとは、再生中にその情報を見ながら、動画が遅れていれば読み上げを待ちにし、逆に読み上げが遅れていれば動画を停止して待ちにしています。これだけで、かなり画面に合わせて読み上げが行われることがわかると思います。

## 生成した翻訳データについて

翻訳したデータ(JSONファイル)は、アプリのドキュメントフォルダに保存されます。ファイルアプリから参照することができるので、必要に応じてバックアップしてください。シミュレータをご使用の場合は、アプリ起動時にドキュメントフォルダのパスをログに出しているので、それをファインダアプリで開くことで簡単に参照できます。ドキュメントフォルダのファイルは以下の２種類です。他の端末で動かしたい場合は、これらのファイルをアプリのドキュメントフォルダにおくことで翻訳したデータを参照できます。
- xxx_list.json 年度毎の動画のリスト
- xxx_xxxx_xx.json 動画１つの翻訳データ

なお、翻訳したデータといえども元はAppleの著作物です。あくまで個人利用にとどめ、これらのファイルの公開は行わないように注意して下さい。

## ソースコードの構成

アプリは、HonnyakuWWDCとHonnyakuWWDCClassicPlayerの２つで構成されます。この2つのアプリはある程度ソースコードを共有しています。各アプリは、プロジェクトの以下のフォルダを見ています。

- HonnyakuWWDC
  - HonnyakuWWDC/HonnyakuWWDC以下の全て

- HonnyakuWWDCClassicPlayer
  - HonnyakuWWDC/HonnyakuWWDCClassicPlayer以下のファイル
  - HonnyakuWWDC/HonnyakuWWDC/Core
  - HonnyakuWWDC/HonnyakuWWDC/VideoDetail

HonnyakuWWDCClassicPlayerは、HonnyakuWWDCの一部のフォルダのコードを利用している感じですね。HonnyakuWWDCClassicPlayerは旧バージョンOS向けなので、共有しているコードではiOS16SDKの機能は使っていません。

フォルダ内の各コードは、VIPERとMVVMのようなレイヤードな構成を意識しています。


## 他の言語への翻訳

現在このアプリは日本語しか選択できませんが、DeepLとAppleの読み上げ機能は他の多くの言語に対応しています。ソースコード中の言語の定義を増やせば、他の言語でもいけるんちゃうかなと思います。確認してないけど。

## ソースコードの指摘歓迎

私は、SwiftUIでアプリ全体のUIを書くのは初めてなのと、iOS16SDKについても手探りなので、変な箇所があるかもしれません。issueやプルリクで指摘歓迎です。
